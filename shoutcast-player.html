<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/av-icons.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="./behavior/string-behavior.html">
<link rel="import" href="../moment-element/moment-element.html">
<link rel="import" href="../moment-element/moment-with-locales-import.html">

<script src="../webcomponentsjs/webcomponents-lite.js"></script>

<dom-module id="shoutcast-player">
  <template>
  <style>
  :host {
    width: 100%;
  }

  .self-start {
    -ms-align-self: flex-start;
    -webkit-align-self: flex-start;
    align-self: flex-start;
  }

  .self-end {
    -ms-align-self: flex-end;
    -webkit-align-self: flex-end;
    align-self: flex-end;
  }

  iron-icon {
    cursor: pointer;
  }

  .flex-horizontal {
    @apply(--layout-horizontal);
  }
  .flexchild {
    @apply(--layout-flex);
  }

  .flex-vertical {
    @apply(--layout-vertical);
  }

  .flexchild-vertical {
    @apply(--layout-flex);
  }

  .flex-center-justified {
    @apply(--layout-horizontal);
    @apply(--layout-center-justified);
  }

  paper-slider {
    width: 100%;
  }

  .image-container {
    width: 100px;
    margin-right: 10px;
    
  }

  iron-image{
    --iron-image-width: 100%;
    --iron-image-height:	100%;
    padding:10px;
  }

  #listContainer {
    background-color:#fafafa;
    color: #666;
  }

  #listContainer ul {
    background-color: #fafafa;
    list-style: none;
    padding:0px;
    margin: 0px;
    font-size: 11px;
  }

  #listContainer li {
    padding:8px;
    margin-bottom: 2px;
    display: flex;
    justify-content: space-between;
  }

  #listContainer .title {
    overflow: hidden;
    white-space:nowrap;
    text-overflow:ellipsis;
    width:70%;
    display:inline-block;
  }

  #listContainer .time {
    font-size: 10px;
    color: #888;
    white-space:nowrap;
    overflow:visible;
  }

  ul li:nth-child(even){
      background-color: rgba(239, 239, 239, 0.63);
  }

  .controls-decorator {
    background-color: var(--paper-grey-200);
    padding: 0.2rem;
  }
  
  .controls-decorator .container {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .controls-decorator .container button {
     max-width: 50%;
  }


  .radio-now .title {
    font-size: 16px;
  }

  .radio-container {
    background-color: #2956cb;
    color: #EEE;
    margin-bottom: 10px;
  }

  .current-song-container {
    background-color: var(--paper-grey-200); 
    padding: 0.6rem;
  }

  .current-song-container .title{
    text-overflow: ellipsis;
    overflow: hidden;
    font-size: 1.2rem;
  }

  .current-song-container .subtitle{
    color: var(--paper-grey-500);
  }

  .history-list {
    margin: 1.2rem 0 0.4rem 0;
    color: var(--paper-grey-500);
  }

  </style>


  <iron-ajax id="ajax"
  auto
  url="{{src}}/7.html"
  on-response="_onMetaDataRetrieved"
  handle-as="html">
</iron-ajax>

<iron-ajax id="ajax"
auto
url="{{src}}/played.html"
on-response="_onSongListRetrieved"
handle-as="html">
</iron-ajax>

<audio id="audio" src="{{src}}/;stream.mp3"></audio>

<div class="container flex-vertical">
  <div>
    <div class="controls-decorator">
      <div class="container flex-horizontal">
        <div id="left" class="button" on-click="playPause">
          <iron-icon id="play" icon="av:play-arrow" hidden$="{{ isPlaying }}"></iron-icon>
          <iron-icon id="pause" icon="av:stop" hidden$="{{ !isPlaying }}"></iron-icon>
        </div>
        <div class="flexchild">
          <paper-slider id="volumenSlider" min="0" max="1" value="{{sliderVolume}}" step="0.01" on-value-change="_onVolumeChange"></paper-slider>
        </div>
        <div id="volumeButton" on-click="loudAndMute">
          <iron-icon id="loudness" icon="av:volume-up" hidden$="{{ !hasLoudness }}"></iron-icon>
          <iron-icon id="mute" icon="av:volume-off" hidden$="{{ hasLoudness }}"></iron-icon>
        </div>
      </div>
    </div>
  </div>
  <div class="flexchild-vertical">
    <iron-image src="images/default_show.jpg"></iron-image>
  </div>
  <div class="current-song-container">
    <paper-item>
      <paper-item-body two-line>
        <div class="title">{{ currentSong.song }}</div>
        <div secondary class="subtitle">Empezó hace {{ currentSong.start }}</div>
      </paper-item-body>
    </paper-item>
  </div>
  <div>
    <div class="history-list">Programas anteriores:</div>
    <div id="listContainer" class="playlistContainer">
      <ul id="playListContainer">
        <template is="dom-repeat" items="{{songHistory}}">
          <li><span class="title truncate">{{item.song}}</span><span class="time">{{item.start}}</span></li>
        </template>
      </ul>
    </div>
  </div>
</div>
</template>

<script>
Polymer({
  is: 'shoutcast-player',
  behaviors: [StringBehavior],

  properties: {
    src: {
      type: String
    },
    metaData: {
      type: Object
    },

    songHistory: {
      type: Array
    },

    currentSong: {
      type: String,
      value: 'www.mariskalrock.com',
      computed: '_getCurrentSong(songHistory)'
    },

    title: String,

    isPlaying: {
      type: Boolean,
      value: false
    },

    hasLoudness: {
      type: Boolean,
      value: true
    },

    sliderVolume: {
      type: Number,
      value: 1
    }
  },

  ready: function () {
    moment.locale('es');

  },

  playPause: function(e) {
    e.preventDefault();

    var player = this;

    if ( player.$.audio.paused ) {
      player.$.audio.play();
      player.isPlaying = true;
    } else {
      player.$.audio.pause();
      player.isPlaying = false;
    }
  },

  loudAndMute: function(e) {
    e.preventDefault();

    if ( !this.hasLoudness ) {
      this.$.audio.volume = this.$.volumenSlider.value;
      this.hasLoudness = true;
    } else {
      this.$.audio.volume = 0;
      this.hasLoudness = false;
    }
  },

  _onVolumeChange: function (v) {
    this.$.audio.volume = this.$.volumenSlider.value;
    this.hasLoudness = !(this.$.volumenSlider.value === 0);
  },

  _onMetaDataRetrieved: function (response) {
    var params = response.detail.response.match(/<body[^>]*>([\w|\W]*)<\/body>/im);
    this._parseMetaData(params[1]);
  },

  _parseMetaData: function (data) {
    var parsedData = (data || '').split(',');
    this.metaData = {
      concurrentListeners: parsedData[0],
      streamStatus: parsedData[1],
      maxListenersStream: parsedData[2],
      maxClientConnectionsAllowed: parsedData[3],
      uniqueClientConnections: parsedData[4],
      currentBitRate: parsedData[5],
      song: parsedData[6]
    };
  },

  _onSongListRetrieved: function (response){
    var el = document.createElement( 'html' );
    var rows = undefined;
    var cols = undefined;
    var i = 1;
    var rowsLength = undefined;
    var result = [];

    this.songHistory = [];

    el.innerHTML = response.detail.response;
    rows = el.getElementsByTagName('table')[2].getElementsByTagName('tr')
    rowsLength = rows.length;

    for (i; i < rowsLength;i++){
      cols = rows[i].getElementsByTagName('td');
      result.push({
        start: this._formatTime(cols[0].innerHTML),
        song: this.cleanString(cols[1].innerHTML),
        now: !!cols[2]
      });
    }
    this.songHistory = result;
    
    this.currentSong = this.songHistory[0];
    this.songHistory.shift();
  },

  _formatTime: function (time) {
    var formatedTime =  new moment(time, 'HH:mm:ss');
    return formatedTime.fromNow();
  },

  _getCurrentSong:function (list) {
    var result;
    var found = false;
    var i = 0;
    var item;
    var listLength = list ? list.length :  [];

    for (i; i < listLength && !found ; i++) {
      item = list[i];

      if(item.now) {
        found = true;
        result = item;
      }
    }
    return result;
  },

  _getClass: function(item) {
    return (item % 2 === 0)? 'even': 'odd';
  }
});
</script>
</dom-module>
